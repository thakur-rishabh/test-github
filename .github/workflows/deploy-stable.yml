name: Deploy to Stable

on:
  pull_request:
    types: [closed]
    branches:
      - stable

env:
  PRINCIPAL_ENGINEER_USERNAME: 'resu312'

jobs:
  call-build-workflow:
    name: Build Project
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/build.yml
    secrets:
      first: test

  deploy:
    name: Deploy to stable Environment
    needs: call-build-workflow
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://your-app-prod-url.com

    steps:
      - name: Checkout codes
        uses: actions/checkout@v4

      - name: Echo Deployment Information
        run: |
          echo "üöÄ Starting deployment to Production..."
          echo "Triggered by PR #${{ github.event.number }} merge to ${{ github.base_ref }}"
          echo "Merged by: ${{ github.event.pull_request.merged_by.login }}"
          echo "Commit to deploy: ${{ github.sha }}" # This will be the merge commit SHA

      - name: test var
        shell: bash
        run: |
          echo "sha_test=$(git rev-parse --short ${GITHUB_SHA})" >> $GITHUB_ENV

      - name: Print Short SHA Environment Variable
        run: |
          echo "The short SHA set in the previous step is: ${{ env.sha_test }}"

      - name: Simulate Deployment to Production Servers
        run: |
          echo "üåç Simulating deployment to production servers..."
          echo "Connecting to server cluster..."
          sleep 5

      - name: Run tests (example step that will intentionally fail)
        id: test
        run: |
          echo "Running tests..."
          echo "This step will intentionally fail to test notifications."
          exit 0 # This causes the step to fail
          echo "Tests successful!" # This line will not be reached

      - name: Notify on Failure
        if: failure() # This condition ensures this step runs only if any previous step in this job fails
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            :x: **Workflow Failure!**

            Hi @${{ github.event.pull_request.user.login }} (cc: @${{ env.PRINCIPAL_ENGINEER_USERNAME }}),
            One or more checks in the CI workflow failed for this PR.

            Please review the [workflow run logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details and to identify the cause of the failure.
          edit-mode: replace 
          reactions: 'confused'


      
